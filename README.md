# pie-reporter

A collection of scripts enabling analysis of PieDAO staking initiative.

## How to run

First, init a virtualenv:

```
python3.8 -m venv ./env # creates a python virtualenv
source ./env activate
pip install -r requirements.txt
```

To build a distribution:

> ðŸ’¡ Note that you need to use **Python 3.8** for all of these scripts to work properly.

```sh
# replace these as required
export NEW_REPORT=2022-8;
export OLD_REPORT=2022-7;

python3.8 ./reporter/run.py conf
python3.8 ./reporter/run.py build  "./reports/$NEW_REPORT" "./reports/$OLD_REPORT"
python3.8 ./reporter/run.py report "./reports/$NEW_REPORT" "./reports/$OLD_REPORT"

```

## Reports generated explained for Dummies

```
reports/<month-year>
â”œâ”€â”€ csv
     â”œâ”€â”€ distribution.csv: Rewards distributed for this epoch (including slashed)
     â”œâ”€â”€ rewards.csv: Rewards distributed including any unclaimed reward
     â”œâ”€â”€ voters.csv: Addresses that voted on the reporting epoch
     â”œâ”€â”€ non_voters.csv: Addresses that did not vote on the reporting epoch
     â”œâ”€â”€ votes.csv: Address vote history per proposal during the reporting epoch
     â”œâ”€â”€ proposals.csv: All eligible proposals considered for the reporting epoch
     â””â”€â”€ stakers.csv: Amount of veDough staked per address
â”œâ”€â”€ json
     â”œâ”€â”€ rewards.json: rewards.csv in a JSON format
     â””â”€â”€ stakers.json: stakers.csv in a JSON format
â”œâ”€â”€ claims.json: Claims for this epoch (used to generate the merkle tree)
â”œâ”€â”€ epoch-conf.json: Epoch configuration
â”œâ”€â”€ reporter-db.json: JSON format document-based database (used by the reporter)
â””â”€â”€ merkle-tree.json: Final merkle tree
```

We also generate a /reports/latest folder. As the name suggests this contains the latest merkle-tree which can be used by applications to the most up to date distribution data. 

## Checking discrepancy with the claims generated by the backend

```sh
python3.8 ./reporter/double_checker/double_checker.py check "./reports/$NEW_REPORT/reporter-db.json" "./reports/$NEW_REPORT/diff/epoch-$NEW_REPORT.json"
```

> Example: `python3.8 ./reporter/double_checker/double_checker.py check reports/2022-6/reporter-db.json epoch-2022-6.json`

## Generating final tree
```sh
# only run once
yarn 

yarn ts-node ./scripts/CreateClaims.ts -i "./reports/$NEW_REPORT/claims.json" -o $NEW_REPORT 
```
### Future improvements

- [ ] Implement a CLI to query `reporter-db`
